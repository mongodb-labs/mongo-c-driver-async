
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Couroutines &#8212; amongoc 0.1.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles.css?v=9a558a22" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=e7471476"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'dev/coroutines';</script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="result&lt;T&gt;" href="../result/" />
    <link rel="prev" title="Nanosenders" href="../nanosenders/" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../">
  
  
  
  
  
  
    <p class="title logo__title">amongoc 0.1.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../learn/">Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../learn/bson/">BSON Handling</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../learn/bson/lifetime/">Creation &amp; Destruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../learn/bson/inserting/">Adding Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../learn/bson/reading/">Reading BSON Data</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../learn/box/">Storing Values in a Type-Erased Box</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../learn/connect/">Connecting to a MongoDB Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../learn/write/">Writing Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../learn/read/">Reading Data</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../how-to/">How-to Guides</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/status-handling/">How to Handle <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_status</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/communicate/">Communicating with a Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../how-to/looping/">Creating Asynchronous Loops</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ref/">Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ref/meta-attrs/">Meta-Reference: Documentation Attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/api-patterns/"><code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code> API Patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/building/">Configuring, Building, &amp; Using</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/box/">Dynamically Types Boxes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/status/">Status Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/emitter/">Emitter API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/operation/">Operation API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/async/">Asynchronous Utility APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/alloc/">Dynamic Memory Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/client/">Client API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/database/">Database Handle API</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ref/collection/">Collection &amp; Data API</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../ref/coll-ops/">Collection Operations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/params/">Common Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/aggregate/">Aggregate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/count/">Count</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/delete/">Delete</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/distinct/">Distinct</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/drop/">Drop</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/find/">Find</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/insert/">Insert</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/replace/">Replace</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../ref/coll-ops/update/">Update</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/loop/">Type: <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_loop</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/handler/">Handler APIs</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ref/bson/">BSON Library</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ref/bson/types/">BSON Value Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref/bson/value/">BSON Values</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref/bson/view/">BSON Reading</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref/bson/iter/">BSON Iteration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref/bson/doc/">BSON Documents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ref/bson/mut/">BSON Modifying</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/str/">Strings &amp; String Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/vec/">Vector Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/time/">Time Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ref/glossary/">Terminology</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../explain/">Design &amp; Explanation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../explain/why-async/">Why Asynchrony?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explain/consider/">Design Considerations in <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../explain/async-model/">Our Asynchrony Model</a></li>
</ul>
</details></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../"><code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code> Developer Documentation</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../guidelines/">Development Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deletion/">C Object Deletion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nanosenders/">Nanosenders</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Couroutines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../result/"><code class="docutils literal notranslate"><span class="pre">result&lt;T&gt;</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../queries/">Query Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../asio/">Asio in <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../tls/">TLS Streams</a></li>
<li class="toctree-l2"><a class="reference internal" href="../documenting/">Documenting <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../bson-building/">Declaratively Building BSON Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bson-parsing/">Declaratively Parsing BSON Objects</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mongodb-labs/mongo-c-driver-async" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mongodb-labs/mongo-c-driver-async/blob/develop/docs/dev/coroutines.rst?plain=1" target="_blank"
   class="btn btn-sm btn-source-file-button dropdown-item"
   title="Show source"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">Show source</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mongodb-labs/mongo-c-driver-async/edit/develop/docs/dev/coroutines.rst" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mongodb-labs/mongo-c-driver-async/issues/new?title=Issue%20on%20page%20%2Fdev/coroutines.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/dev/coroutines.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Couroutines</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coroutine-types">Coroutine Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#amongoc-emitter-as-a-coroutine"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code> as a Coroutine</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-explicit-ramp-end">The Explicit Ramp End</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exception-handling-with-amongoc-emitter">Exception Handling with <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#amongoc-co-task-as-a-coroutine"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc::co_task</span></code> as a Coroutine</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_taskE"><code class="docutils literal notranslate"><span class="pre">co_task</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task11result_typeE"><code class="docutils literal notranslate"><span class="pre">result_type</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4NO7amongoc7co_task9as_senderEv"><code class="docutils literal notranslate"><span class="pre">as_sender()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exception-handling-with-co-task">Exception Handling with <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#awaitable-types">Awaitable Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exception-throwing">Exception Throwing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#memory-allocation">Memory Allocation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#allocation-failure">Allocation Failure</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-lifetimes">Parameter Lifetimes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coroutines-versus-nanosenders">Coroutines Versus Nanosenders</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-coroutines">When to Use Coroutines</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-nanosenders">When to Use Nanosenders</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coroutine-machinery-in-amongoc">Coroutine Machinery in <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#triggering-coroutine-magic">Triggering Coroutine Magic</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#support-concepts">Support Concepts</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7awaiterE"><code class="docutils literal notranslate"><span class="pre">awaiter</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7awaiter13await_suspendEDaNSt16coroutine_handleI1PEE"><code class="docutils literal notranslate"><span class="pre">await_suspend()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7awaiter12await_resumeEv"><code class="docutils literal notranslate"><span class="pre">await_resume()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7awaiter11await_readyEv"><code class="docutils literal notranslate"><span class="pre">await_ready()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc9awaitableE"><code class="docutils literal notranslate"><span class="pre">awaitable</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#promise-types">Promise Types</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc17promise_interfaceE"><code class="docutils literal notranslate"><span class="pre">promise_interface</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface17get_return_objectEv"><code class="docutils literal notranslate"><span class="pre">get_return_object()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface39get_return_object_on_allocation_failureEv"><code class="docutils literal notranslate"><span class="pre">get_return_object_on_allocation_failure()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface19unhandled_exceptionEv"><code class="docutils literal notranslate"><span class="pre">unhandled_exception()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface15initial_suspendEv"><code class="docutils literal notranslate"><span class="pre">initial_suspend()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface13final_suspendEv"><code class="docutils literal notranslate"><span class="pre">final_suspend()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface12return_valueERRDa"><code class="docutils literal notranslate"><span class="pre">return_value()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface17promise_interfaceEDpRRDa"><code class="docutils literal notranslate"><span class="pre">promise_interface()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interfacenwE11std__size_tDpRRDa"><code class="docutils literal notranslate"><span class="pre">operator</span> <span class="pre">new()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interfacedlEPv11std__size_t"><code class="docutils literal notranslate"><span class="pre">operator</span> <span class="pre">delete()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface14get_stop_tokenEv"><code class="docutils literal notranslate"><span class="pre">get_stop_token()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface13get_allocatorEv"><code class="docutils literal notranslate"><span class="pre">get_allocator()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc33coroutine_promise_allocator_mixinE"><code class="docutils literal notranslate"><span class="pre">coroutine_promise_allocator_mixin</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promiseE"><code class="docutils literal notranslate"><span class="pre">emitter_promise</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promise11fin_handlerE"><code class="docutils literal notranslate"><span class="pre">fin_handler</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4NK7amongoc15emitter_promise14get_stop_tokenEv"><code class="docutils literal notranslate"><span class="pre">get_stop_token()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promise39get_return_object_on_allocation_failureEv"><code class="docutils literal notranslate"><span class="pre">get_return_object_on_allocation_failure()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promise19unhandled_exceptionEv"><code class="docutils literal notranslate"><span class="pre">unhandled_exception()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promise13final_suspendEv"><code class="docutils literal notranslate"><span class="pre">final_suspend()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_task13finisher_baseE"><code class="docutils literal notranslate"><span class="pre">finisher_base</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task13finisher_base16on_final_suspendEv"><code class="docutils literal notranslate"><span class="pre">on_final_suspend()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task13finisher_base10stop_tokenEv"><code class="docutils literal notranslate"><span class="pre">stop_token()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_task12promise_typeE"><code class="docutils literal notranslate"><span class="pre">promise_type</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task12promise_type9_finisherE"><code class="docutils literal notranslate"><span class="pre">_finisher</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task12promise_type14get_stop_tokenEv"><code class="docutils literal notranslate"><span class="pre">get_stop_token()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task12promise_type13final_suspendEv"><code class="docutils literal notranslate"><span class="pre">final_suspend()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#awaiting-a-nanosender">Awaiting a Nanosender</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I_10nanosenderEN7amongoc18nanosender_awaiterE"><code class="docutils literal notranslate"><span class="pre">nanosender_awaiter</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4NK7amongoc18nanosender_awaiter11await_readyEv"><code class="docutils literal notranslate"><span class="pre">await_ready()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc18nanosender_awaiter12await_resumeEv"><code class="docutils literal notranslate"><span class="pre">await_resume()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc18nanosender_awaiter13await_suspendEvNSt16coroutine_handleI7PromiseEE"><code class="docutils literal notranslate"><span class="pre">await_suspend()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#awaiting-a-co-task">Awaiting a <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_task7awaiterE"><code class="docutils literal notranslate"><span class="pre">awaiter</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4NK7amongoc7co_task7awaiter11await_readyEv"><code class="docutils literal notranslate"><span class="pre">await_ready()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task7awaiter12await_resumeEv"><code class="docutils literal notranslate"><span class="pre">await_resume()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_task7awaiter13await_suspendENSt16coroutine_handleIEENSt16coroutine_handleI1PEE"><code class="docutils literal notranslate"><span class="pre">await_suspend()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="couroutines">
<h1>Couroutines<a class="headerlink" href="#couroutines" title="Link to this heading">#</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This page is for <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code> developers and the documented components and
behavior are not part of any public API guarantees.</p>
</div>
<p>The C++ implementation of <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code> can use C++ coroutines to implement
asynchronous control flow.</p>
<p>For simple operations, prefer to compose <a class="reference internal" href="../nanosenders/"><span class="doc">nanosenders</span></a>
directly. For more complex control flow, using coroutines enhances
maintainability and readability.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Be sure to read the <a class="reference internal" href="#co-alloc"><span class="std std-ref">Memory Allocation</span></a> section below, which specifies requirements
on the parameters of coroutines.</p>
</div>
<section id="coroutine-types">
<h2>Coroutine Types<a class="headerlink" href="#coroutine-types" title="Link to this heading">#</a></h2>
<section id="amongoc-emitter-as-a-coroutine">
<h3><a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> as a Coroutine<a class="headerlink" href="#amongoc-emitter-as-a-coroutine" title="Link to this heading">#</a></h3>
<p>The C API type <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> is valid as a coroutine function return type.
The coroutine state will be allocated and stored within the
<a class="reference internal" href="../../ref/emitter/#_CPPv4N15amongoc_emitter8userdataE" title="amongoc_emitter::userdata"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter::userdata</span></code></a>, and the coroutine will be destroyed when the
generated emitter is destroyed.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Be sure to read the <a class="reference internal" href="#explicit-ramp"><span class="std std-ref">The Explicit Ramp End</span></a> section!</p>
</div>
<p>Coroutines created from <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> are lazily started only when the
emitter is attached to a handler and the operation is launched with
<a class="reference internal" href="../../ref/operation/#_CPPv413amongoc_startP17amongoc_operation" title="amongoc_start"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_start()</span></code></a>.</p>
<p>From within an <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> coroutine, one of the following can be returned
with <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_return</span></code>:</p>
<ul class="simple">
<li><p>An <a class="reference internal" href="../../ref/emitter/#_CPPv4N7amongoc14emitter_resultE" title="amongoc::emitter_result"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">emitter_result</span></code></a> – allows returning both an <a class="reference internal" href="../../ref/status/#_CPPv414amongoc_status" title="amongoc_status"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_status</span></code></a> and a boxed
result value.</p></li>
<li><p>A <a class="reference internal" href="../../ref/box/#_CPPv4N7amongoc10unique_boxE" title="amongoc::unique_box"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">unique_box</span></code></a> – resolves with status <a class="reference internal" href="../../ref/status/#_CPPv412amongoc_okay" title="amongoc_okay"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_okay</span></code></a> and the given value as
the result value.</p></li>
<li><p>An <a class="reference internal" href="../../ref/status/#_CPPv414amongoc_status" title="amongoc_status"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_status</span></code></a> – the result value will be <a class="reference internal" href="../../ref/box/#_CPPv411amongoc_nil" title="amongoc_nil"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_nil</span></code></a>.</p></li>
<li><p>A <a class="reference external" href="https://en.cppreference.com/w/cpp/error/error_code" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::error_code</span></code></a> – this will be converted using <a class="reference internal" href="../../ref/status/#_CPPv4N14amongoc_status4fromE15std__error_code" title="amongoc_status::from"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_status::from()</span></code></a>,
and the result value will be <a class="reference internal" href="../../ref/box/#_CPPv411amongoc_nil" title="amongoc_nil"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_nil</span></code></a>.</p></li>
<li><p><code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">nullptr</span></code> or literal <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="mi">0</span></code> – will construct an emitter result with
<a class="reference internal" href="../../ref/status/#_CPPv412amongoc_okay" title="amongoc_okay"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_okay</span></code></a> and <a class="reference internal" href="../../ref/box/#_CPPv411amongoc_nil" title="amongoc_nil"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_nil</span></code></a>. This return kind is “mere success”, akin to
returning <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="kt">void</span></code>.</p></li>
</ul>
<section id="the-explicit-ramp-end">
<span id="explicit-ramp"></span><h4>The Explicit Ramp End<a class="headerlink" href="#the-explicit-ramp-end" title="Link to this heading">#</a></h4>
<div class="admonition-tl-dr admonition">
<p class="admonition-title">TL;DR</p>
<p>An <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> coroutine must await <code class="docutils literal notranslate"><span class="pre">amongoc::ramp_end</span></code> exactly once
before doing anything.</p>
</div>
<p>The <em>coroutine ramp</em> is a special construct generated by the compiler and is the
portion of code evaluated immediately when a coroutine function is called, and
continues until the first suspend point in the coroutine. The compiler will
insert coroutine ramp code automatically for all coroutines. This is the code
that initializes the promise and copies the coroutine arguments into the
coroutine state.</p>
<p>If a coroutine is set to <a class="reference external" href="https://en.cppreference.com/w/cpp/coroutine/suspend_always" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::suspend_always</span></code></a> at its
<a class="reference internal" href="#_CPPv4N7amongoc17promise_interface15initial_suspendEv" title="amongoc::promise_interface::initial_suspend"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">promise_interface::initial_suspend()</span></code></a> point, the coroutine ramp is entirely
hidden. The <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> coroutine is different from the <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a>
coroutine in that it is <em>eager starting</em>. That is: It’s initial suspend point is
<a class="reference external" href="https://en.cppreference.com/w/cpp/coroutine/suspend_never" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::suspend_never</span></code></a>, meaning it does not start suspended. An <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a>
coroutine <em>must</em> explicitly suspend <strong>exactly once</strong> before it attempts to call
any other coroutines or perform any asynchronous operations. This should be
performed by awaiting the special <code class="docutils literal notranslate"><span class="pre">amongoc::ramp_end</span></code> object <strong>exactly once</strong>.</p>
<p>The purpose of this design is so that an <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> coroutine may make
copies of its arguments before suspending and returning control to the caller.
This is useful to capture arguments by-value that were passed by reference from
the caller. For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">amongoc_emitter</span><span class="w"> </span><span class="n">do_something</span><span class="p">(</span><span class="n">mlib_allocator</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">some_string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// We want to take a copy of `some_string` from the caller to persist it</span>
<span class="w">  </span><span class="c1">// in the coroutine state.</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">amongoc</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">some_string</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
<span class="w">  </span><span class="k">co_await</span><span class="w"> </span><span class="n">amongoc</span><span class="o">::</span><span class="n">ramp_end</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// The caller may have freed `some_string`, but we are okay because we have</span>
<span class="w">  </span><span class="c1">// a copy in `s`</span>

<span class="w">  </span><span class="c1">// Do the rest of the asynchronous operation...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">amongoc::ramp_end</span></code> will suspend the coroutine and resume to the caller.
This allows us to effectively add our own custom code to the coroutine ramp.</p>
<p>Refer to the implementation of CRUD operations for clear examples of using
<code class="docutils literal notranslate"><span class="pre">ramp_end</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>It is safe</em> for an <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> to throw an exception or return a value
before the <code class="docutils literal notranslate"><span class="pre">ramp_end</span></code>.</p>
</div>
</section>
<section id="exception-handling-with-amongoc-emitter">
<h4>Exception Handling with <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a><a class="headerlink" href="#exception-handling-with-amongoc-emitter" title="Link to this heading">#</a></h4>
<p>If an <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> coroutine throws an exception, the following will happen:</p>
<ol class="arabic simple">
<li><p>If the exception is derived from <a class="reference external" href="https://en.cppreference.com/w/cpp/error/system_error" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::system_error</span></code></a>, the error code will be
given to <a class="reference internal" href="../../ref/status/#_CPPv4N14amongoc_status4fromE15std__error_code" title="amongoc_status::from"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_status::from()</span></code></a> and the resulting status object will be the
result status of the emitter, with an <a class="reference internal" href="../../ref/box/#_CPPv411amongoc_nil" title="amongoc_nil"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_nil</span></code></a> result value.</p></li>
<li><p>Otherwise, if the exception type is derived from an <a class="reference internal" href="../../ref/status/#_CPPv4N7amongoc9exceptionE" title="amongoc::exception"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc::exception</span></code></a>,
then the <a class="reference internal" href="../../ref/status/#_CPPv4NK7amongoc9exception6statusEv" title="amongoc::exception::status"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">exception::status()</span></code></a> will be the result status of the emitter.</p></li>
<li><p>Otherwise, if the exception type is <a class="reference external" href="https://en.cppreference.com/w/cpp/memory/new/bad_alloc" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::bad_alloc</span></code></a>, the emitter
will resolve with generic cateogry and <code class="docutils literal notranslate"><span class="pre">ENOMEM</span></code>.</p></li>
<li><p>Otherwise, <strong>the program will terminate</strong>. <em>Don’t let this happen!</em></p></li>
</ol>
</section>
</section>
<section id="amongoc-co-task-as-a-coroutine">
<h3><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc::co_task</span></code></a> as a Coroutine<a class="headerlink" href="#amongoc-co-task-as-a-coroutine" title="Link to this heading">#</a></h3>
<dl class="cpp class">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc7co_taskE">
<span id="_CPPv3I0EN7amongoc7co_taskE"></span><span id="_CPPv2I0EN7amongoc7co_taskE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">T</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="k"><span class="pre">class</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">co_task</span></span></span><a class="headerlink" href="#_CPPv4I0EN7amongoc7co_taskE" title="Link to this definition">#</a><br /></dt>
<dd><p>This is a dedicated C++ coroutine return type. It is move-only. Using a
<a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> as a coroutine is more efficient than using <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a>, but
is not part of the public API, so its usage is limited to internal interfaces
only.</p>
<dl class="cpp type">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc7co_task11result_typeE">
<span id="_CPPv3N7amongoc7co_task11result_typeE"></span><span id="_CPPv2N7amongoc7co_task11result_typeE"></span><span class="k"><span class="pre">using</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">result_type</span></span></span><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><a class="reference internal" href="../result/#_CPPv4I00EN7amongoc6resultE" title="amongoc::result"><span class="n"><span class="pre">result</span></span></a><span class="p"><span class="pre">&lt;</span></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task::T"><span class="n"><span class="pre">T</span></span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://en.cppreference.com/w/cpp/error/exception_ptr" title="(in cppreference v0)"><span class="n"><span class="pre">std::exception_ptr</span></span></a><span class="p"><span class="pre">&gt;</span></span><a class="headerlink" href="#_CPPv4N7amongoc7co_task11result_typeE" title="Link to this definition">#</a><br /></dt>
<dd></dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4NO7amongoc7co_task9as_senderEv">
<span id="_CPPv3NO7amongoc7co_task9as_senderEv"></span><span id="_CPPv2NO7amongoc7co_task9as_senderEv"></span><span id="amongoc::co_task::as_senderO"></span><a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><span class="n"><span class="pre">nanosender</span></span></a><span class="w"> </span><span class="k"><span class="pre">auto</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">as_sender</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="p"><span class="pre">&amp;&amp;</span></span><a class="headerlink" href="#_CPPv4NO7amongoc7co_task9as_senderEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Convert the coroutine to a nanosender. It will send a <a class="reference internal" href="#_CPPv4N7amongoc7co_task11result_typeE" title="amongoc::co_task::result_type"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">result_type</span></code></a> object.</p>
</dd></dl>

</dd></dl>

<section id="exception-handling-with-co-task">
<h4>Exception Handling with <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a><a class="headerlink" href="#exception-handling-with-co-task" title="Link to this heading">#</a></h4>
<p>If a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> <span class="math notranslate nohighlight">\(A\)</span> is awaited within another <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> coroutine <span class="math notranslate nohighlight">\(B\)</span> and the
coroutine associated with <span class="math notranslate nohighlight">\(A\)</span> throws an exception <span class="math notranslate nohighlight">\(x\)</span>, then <span class="math notranslate nohighlight">\(x\)</span> will be
re-thrown within <span class="math notranslate nohighlight">\(B\)</span> when <span class="math notranslate nohighlight">\(A\)</span> is <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code>’d.</p>
<p><strong>When used as a</strong> <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> (i.e. with <a class="reference internal" href="#_CPPv4NO7amongoc7co_task9as_senderEv" title="amongoc::co_task::as_sender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task::as_sender()</span></code></a> ), if the
underlying coroutine throws an unhandled exception, then the sent <a class="reference internal" href="../result/#_CPPv4I00EN7amongoc6resultE" title="amongoc::result"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">result</span></code></a>
object will contain a <a class="reference external" href="https://en.cppreference.com/w/cpp/error/exception_ptr" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::exception_ptr</span></code></a> for that exception.</p>
</section>
</section>
</section>
<section id="awaitable-types">
<h2>Awaitable Types<a class="headerlink" href="#awaitable-types" title="Link to this heading">#</a></h2>
<p>Within an <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> coroutine or a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> coroutine, any type that
meets <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> is valid for <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code>-ing (this includes
<a class="reference internal" href="../../ref/emitter/#_CPPv4N7amongoc14unique_emitterE" title="amongoc::unique_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">unique_emitter</span></code></a> itself, since it implements the <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> interface).</p>
<p>When awaiting a <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> <span class="math notranslate nohighlight">\(S\)</span>, a special receiver will be connected to <span class="math notranslate nohighlight">\(S\)</span>
that will resume the parent coroutine. This will schedule the coroutine to be
resumed by <span class="math notranslate nohighlight">\(S\)</span> when it invokes the attached receiver.</p>
<p>The result type from the <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code> on the <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> will be the
<a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc7sends_tE" title="amongoc::sends_t"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">sends_t</span></code></a> of that nanosender. When awaiting a <a class="reference internal" href="../../ref/emitter/#_CPPv4N7amongoc14unique_emitterE" title="amongoc::unique_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">unique_emitter</span></code></a>, this will be an
<a class="reference internal" href="../../ref/emitter/#_CPPv4N7amongoc14emitter_resultE" title="amongoc::emitter_result"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">emitter_result</span></code></a>.</p>
<section id="exception-throwing">
<h3>Exception Throwing<a class="headerlink" href="#exception-throwing" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a>s, unlike P2300 senders, do not have a distinct error channel. For
that reason, <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code>-ing a nanosender will never throw an exception.
Instead, error information must be transmitted through the nanosender’s result
type.</p>
</section>
</section>
<section id="memory-allocation">
<span id="co-alloc"></span><h2>Memory Allocation<a class="headerlink" href="#memory-allocation" title="Link to this heading">#</a></h2>
<p>C++ coroutines support customizing the allocation of the coroutine’s state.
Coroutines based on <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> and <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> will <em>refuse</em> to use the
default <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">operator</span><span class="w"> </span><span class="k">new</span></code>, and <em>require</em> that a <a class="reference internal" href="../../ref/alloc/#_CPPv4I0EN4mlib9allocatorE" title="mlib::allocator"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">mlib::allocator</span></code></a> is
provided to the coroutine.</p>
<p>For this reason, a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> or <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> coroutine <em>must</em> accept as its
first parameter one of:</p>
<ol class="arabic simple">
<li><p>A pointer to <a class="reference internal" href="../../ref/loop/#_CPPv412amongoc_loop" title="amongoc_loop"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_loop</span></code></a> (which is assumed to never be <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">nullptr</span></code>!) –
The <a class="reference internal" href="../../ref/alloc/#_CPPv4I0EN4mlib9allocatorE" title="mlib::allocator"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">mlib::allocator</span></code></a> will be obtained from the event loop.</p></li>
<li><p>A <a class="reference internal" href="../../ref/alloc/#_CPPv4I0EN4mlib9allocatorE" title="mlib::allocator"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">mlib::allocator</span></code></a> directly.</p></li>
<li><p>An <a class="reference internal" href="../../ref/alloc/#_CPPv414mlib_allocator" title="mlib_allocator"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">mlib_allocator</span></code></a>, which will be converted to a <a class="reference internal" href="../../ref/alloc/#_CPPv4I0EN4mlib9allocatorE" title="mlib::allocator"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">mlib::allocator</span></code></a>.</p></li>
<li><p>Any type which supports <a class="reference internal" href="../queries/#_CPPv4N7amongoc13get_allocatorE" title="amongoc::get_allocator"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">get_allocator</span></code></a> with an allocator that is convertible
to a <a class="reference internal" href="../../ref/alloc/#_CPPv4I0EN4mlib9allocatorE" title="mlib::allocator"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">mlib::allocator</span></code></a>.</p></li>
</ol>
<p>If this requirement is not met, then the coroutine will fail to compile when
attempting to resolve the <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">operator</span><span class="w"> </span><span class="k">new</span></code> for the coroutine.</p>
<p class="rubric">Example</p>
<p>Note that the C++ coroutine machinery handles this transparently, so the
parameter need only be present, not necessarily used within the coroutine
itself:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">co_task</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">add_numbers</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="cm">/* unnamed */</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">co_return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the above, event though the <a class="reference internal" href="../../ref/alloc/#_CPPv4I0EN4mlib9allocatorE" title="mlib::allocator"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">mlib::allocator</span></code></a> parameter is unnamed and
unused within the coroutine body, it will still be used by the coroutine’s
promise to allocate memory for the coroutine state.</p>
<section id="allocation-failure">
<h3>Allocation Failure<a class="headerlink" href="#allocation-failure" title="Link to this heading">#</a></h3>
<p>If allocation fails for a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> coroutine, then the coroutine function will
immediately throw without returning a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> object. If allocation fails for
an <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> coroutine, then the returned emitter will be from
<a class="reference internal" href="../../ref/async/#_CPPv421amongoc_alloc_failurev" title="amongoc_alloc_failure"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_alloc_failure()</span></code></a>.</p>
</section>
</section>
<section id="parameter-lifetimes">
<h2>Parameter Lifetimes<a class="headerlink" href="#parameter-lifetimes" title="Link to this heading">#</a></h2>
<p>An important thing to remember about coroutines is that the parameters are
captured by their declared type. This means that reference parameters are
captured by reference, including reference-like types (e.g. <a class="reference external" href="https://en.cppreference.com/w/cpp/string/basic_string_view" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::string_view</span></code></a>
and <a class="reference internal" href="../../ref/bson/view/#_CPPv49bson_view" title="bson_view"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">bson_view</span></code></a>).</p>
<p>Because of these capture semantics, care should be taken that reference-like
parameters outlive the coroutine body for the duration that they are used. This
can be done in one of three ways:</p>
<ol class="arabic">
<li><p>Capture only using value types. This means that <a class="reference external" href="https://en.cppreference.com/w/cpp/string/basic_string_view" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::string_view</span></code></a> and
<code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span></code> should be passed as <a class="reference external" href="https://en.cppreference.com/w/cpp/string/basic_string" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::string</span></code></a> instead.</p></li>
<li><p>Document the lifetime requirements of reference-like parameters. This places
the onus on the user, and is often less than ideal.</p></li>
<li><p>Create a shim function that copies arguments by-value before calling the
real coroutine:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">emitter</span><span class="w"> </span><span class="nf">resolve_addr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">_co_resolve</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">address</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">emitter</span><span class="w"> </span><span class="nf">_co_resolve</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">co_await</span><span class="w"> </span><span class="n">do_stuff</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
<p>Note that this is a non-issue for coroutines that are immediately
<code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code>’d in their caller’s scope, since the lifetime of the arguments
is guaranteed to be at least the lifetime of the coroutine itself:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">co_task</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">use_string</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">co_await</span><span class="w"> </span><span class="n">do_stuff</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">  </span><span class="k">co_return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">co_task</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outer_co</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">co_await</span><span class="w"> </span><span class="n">use_string</span><span class="p">(</span><span class="s">&quot;I am a string&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the above, a temporary <a class="reference external" href="https://en.cppreference.com/w/cpp/string/basic_string" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::string</span></code></a> is passed to <code class="docutils literal notranslate"><span class="pre">use_string</span></code> and the
reference parameter will be bound to that temporary. <strong>This is safe here,</strong> because
the coroutine for <code class="docutils literal notranslate"><span class="pre">use_string</span></code> is immediately awaited and is guaranteed to
complete before the temporary string is destroyed.</p>
</section>
<section id="coroutines-versus-nanosenders">
<h2>Coroutines Versus Nanosenders<a class="headerlink" href="#coroutines-versus-nanosenders" title="Link to this heading">#</a></h2>
<p>It is reasonable to ask when to use coroutines versus using <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a>s
directly. It may be tempting to use coroutines <em>always</em>, since they are easier
to write and read than a pipeline of <a class="reference internal" href="../nanosenders/#_CPPv4I_10nanosender_NSt9invocableI7sends_tI1SEEEEN7amongoc4thenE10nanosenderRR1SRR1H" title="amongoc::then"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">then</span></code></a> and
<a class="reference internal" href="../nanosenders/#_CPPv4I_10nanosender_NSt9invocableI7sends_tI1SEEEEIQ10nanosenderINSt15invoke_result_tI1H7sends_tI1SEEEEEN7amongoc3letE10nanosenderRR1SRR1H" title="amongoc::let"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">let</span></code></a> closures.</p>
<p>The following drawbacks of coroutines over pure nanosenders might be considered:</p>
<ol class="arabic">
<li><p>A coroutine often requires requires dynamic memory allocation, unless the
compiler can perform allocation elision, which is still a very fragile
optimization. A composed nanosender will often require no dynamic memory
allocation at all!</p>
<p>However, this allocation requirement is not usually a problem for
<a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> coroutines, since they would need to dynamically allocate
storage anyway if they would need to use nanosenders that wouldn’t fit inside
of an <a class="reference internal" href="../../ref/box/#_CPPv411amongoc_box" title="amongoc_box"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_box</span></code></a>.</p>
</li>
<li><p>Reference parameter lifetime can be tricky to deal with. This is managable,
but requires care.</p></li>
<li><p>A <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> created from a coroutine will require slightly more
memory than an <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a> created from an equivalent <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a>.</p></li>
</ol>
<section id="when-to-use-coroutines">
<h3>When to Use Coroutines<a class="headerlink" href="#when-to-use-coroutines" title="Link to this heading">#</a></h3>
<p>It should also be considered that coroutines will <em>astronomically</em> improve
maintainability in the face of non-trivial control flow, such as looping,
branching, recursion, and error propagation.</p>
<p>In general, prefer coroutines for high-level constructs that require non-trivial
control flow.</p>
</section>
<section id="when-to-use-nanosenders">
<h3>When to Use Nanosenders<a class="headerlink" href="#when-to-use-nanosenders" title="Link to this heading">#</a></h3>
<p>The pure <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> APIs should be used for very small building-blocks and
high-traffic APIs, since they are guaranteed to be non-allocating.</p>
</section>
</section>
<section id="coroutine-machinery-in-amongoc">
<h2>Coroutine Machinery in <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code><a class="headerlink" href="#coroutine-machinery-in-amongoc" title="Link to this heading">#</a></h2>
<p>This section will be a crash-course on C++20 coroutine machinery and how it is
implemented in <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For a more detailed explanation of how coroutines operate, see
<a class="reference external" href="https://en.cppreference.com/w/cpp/language/coroutines">the cppreference page about C++ coroutines</a>.</p>
</div>
<p>C++ coroutines give a large amount of flexibility to the author in terms of how
they are scheduled and how they communicate with their surrounding context.</p>
<section id="triggering-coroutine-magic">
<h3>Triggering Coroutine Magic<a class="headerlink" href="#triggering-coroutine-magic" title="Link to this heading">#</a></h3>
<p>The C++ coroutine machinery is not triggered by the signature of the function,
but by the presence of a coroutine control keyword within the function body
(i.e. <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code>, <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_return</span></code>, or <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_yield</span></code>). <strong>A function is
not a coroutine unless it uses a coroutine keyword, even if the return type of
the function is a coroutine type</strong>. For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">co_task</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">this_is_not_a_coroutine</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">this_is_a_coroutine</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">co_task</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">this_is_a_coroutine</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">co_return</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the above, <code class="docutils literal notranslate"><span class="pre">this_is_not_a_coroutine</span></code> is a regular function that happens to
return a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> object.</p>
<p>When the compiler sees a coroutine control keyword, it transforms the function
definition into a coroutine function. It uses <a class="reference external" href="https://en.cppreference.com/w/cpp/coroutine/coroutine_traits" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::coroutine_traits</span></code></a> to look
up the <a class="reference internal" href="#term-coroutine-promise"><span class="xref std std-term">promise</span></a> of the coroutine.</p>
</section>
<section id="support-concepts">
<h3>Support Concepts<a class="headerlink" href="#support-concepts" title="Link to this heading">#</a></h3>
<dl class="cpp concept">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc7awaiterE">
<span id="_CPPv3I0EN7amongoc7awaiterE"></span><span id="_CPPv2I0EN7amongoc7awaiterE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">A</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="k"><span class="pre">concept</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">awaiter</span></span></span><a class="headerlink" href="#_CPPv4I0EN7amongoc7awaiterE" title="Link to this definition">#</a><br /></dt>
<dd><div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is not a real library concept, and is only for illustrative purposes</p>
</div>
<p>An awaiter is used at a <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code> expression to control the behavior of
the that <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code> expression and the (possible) suspension of the
enclosing coroutine.</p>
<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc7awaiter13await_suspendEDaNSt16coroutine_handleI1PEE">
<span id="_CPPv3I0EN7amongoc7awaiter13await_suspendENSt16coroutine_handleI1PEE"></span><span id="_CPPv2I0EN7amongoc7awaiter13await_suspendENSt16coroutine_handleI1PEE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">P</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="kt"><span class="pre">auto</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">await_suspend</span></span></span><span class="sig-paren">(</span><span class="n"><span class="pre">std</span></span><span class="p"><span class="pre">::</span></span><span class="n"><span class="pre">coroutine_handle</span></span><span class="p"><span class="pre">&lt;</span></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiter13await_suspendEDaNSt16coroutine_handleI1PEE" title="amongoc::awaiter::await_suspend::P"><span class="n"><span class="pre">P</span></span></a><span class="p"><span class="pre">&gt;</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">suspender</span></span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4I0EN7amongoc7awaiter13await_suspendEDaNSt16coroutine_handleI1PEE" title="Link to this definition">#</a><br /></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Template Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>P</strong> – The <a class="reference internal" href="#term-coroutine-promise"><span class="xref std std-term">promise</span></a> type of the coroutine
that is being suspended.</p>
</dd>
</dl>
<p>When the parent coroutine suspends, it will call <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiter13await_suspendEDaNSt16coroutine_handleI1PEE" title="amongoc::awaiter::await_suspend"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">await_suspend()</span></code></a> with a
<a class="reference internal" href="#term-coroutine-handle"><span class="xref std std-term">handle to the coroutine</span></a> that is being suspended.
This give the awaiter the opportunity to reschedule the coroutine at some
point in the future. If <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiter13await_suspendEDaNSt16coroutine_handleI1PEE" title="amongoc::awaiter::await_suspend"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">await_suspend()</span></code></a> returns a new coroutine handle <span class="math notranslate nohighlight">\(R\)</span>,
then <span class="math notranslate nohighlight">\(R\)</span> will be resumed after the enclosing coroutine suspends (this is
known as <em>symmetric transfer</em>). If <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiter13await_suspendEDaNSt16coroutine_handleI1PEE" title="amongoc::awaiter::await_suspend"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">await_suspend()</span></code></a> returns <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="kt">void</span></code>,
then control returns to the <em>resumer</em> of the coroutine.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc7awaiter12await_resumeEv">
<span id="_CPPv3N7amongoc7awaiter12await_resumeEv"></span><span id="_CPPv2N7amongoc7awaiter12await_resumeEv"></span><span id="amongoc::awaiter::await_resume"></span><span class="kt"><span class="pre">auto</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">await_resume</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc7awaiter12await_resumeEv" title="Link to this definition">#</a><br /></dt>
<dd><p>When the coroutine is resumed, the <a class="reference internal" href="#_CPPv4N7amongoc7awaiter12await_resumeEv" title="amongoc::awaiter::await_resume"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">await_resume()</span></code></a> function will determine
the result of the <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code> expression that uses the awaiter.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc7awaiter11await_readyEv">
<span id="_CPPv3N7amongoc7awaiter11await_readyEv"></span><span id="_CPPv2N7amongoc7awaiter11await_readyEv"></span><span id="amongoc::awaiter::await_ready"></span><span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">await_ready</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc7awaiter11await_readyEv" title="Link to this definition">#</a><br /></dt>
<dd><p>If the <code class="docutils literal notranslate"><span class="pre">await_ready</span></code> function returns <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="nb">true</span></code>, then the coroutine will
skip the call of <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiter13await_suspendEDaNSt16coroutine_handleI1PEE" title="amongoc::awaiter::await_suspend"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">await_suspend()</span></code></a> and immediately calls <a class="reference internal" href="#_CPPv4N7amongoc7awaiter12await_resumeEv" title="amongoc::awaiter::await_resume"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">await_resume()</span></code></a> to
obtain the <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code> result without ever suspending the coroutine.</p>
</dd></dl>

</dd></dl>

<dl class="cpp concept">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc9awaitableE">
<span id="_CPPv3I0EN7amongoc9awaitableE"></span><span id="_CPPv2I0EN7amongoc9awaitableE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">A</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="k"><span class="pre">concept</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">awaitable</span></span></span><a class="headerlink" href="#_CPPv4I0EN7amongoc9awaitableE" title="Link to this definition">#</a><br /></dt>
<dd><p>An object <span class="math notranslate nohighlight">\(A\)</span> is <em>awaitable</em> if:</p>
<ol class="arabic simple">
<li><p>It has a member <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">operator</span><span class="w"> </span><span class="k">co_await</span><span class="p">()</span></code> that returns an <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaiter</span></code></a></p></li>
<li><p>There is a non-member <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">operator</span><span class="w"> </span><span class="k">co_await</span><span class="p">(</span><span class="n">A</span><span class="p">)</span></code> that returns an <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaiter</span></code></a></p></li>
<li><p>The object <span class="math notranslate nohighlight">\(A\)</span> is itself a valid <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaiter</span></code></a></p></li>
</ol>
<p>When a <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code> expression appears in a coroutine body, the compiler
will attempt to obtain an <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaiter</span></code></a> according to the above rules.</p>
</dd></dl>

<dl class="glossary">
<dt id="term-coroutine-handle">coroutine handle<a class="headerlink" href="#term-coroutine-handle" title="Link to this term">#</a></dt><dd><p>The handle of a coroutine is a pointer-like type accessed using
<a class="reference external" href="https://en.cppreference.com/w/cpp/coroutine/coroutine_handle" title="(in cppreference v0)"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">std::coroutine_handle&lt;P&gt;</span></code></a>, where the template
parameter <code class="docutils literal notranslate"><span class="pre">P</span></code> is the <a class="reference internal" href="#term-coroutine-promise"><span class="xref std std-term">promise</span></a> type of the
coroutine, or <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="kt">void</span></code> to represent a handle to a coroutine with an
unknown promise type.</p>
<p>The coroutine handle allows one to resume or destroy a coroutine. If the
template argument is non-<code class="code highlight cpp c++ docutils literal highlight-c++"><span class="kt">void</span></code>, then the promise object can also be
obtained via the coroutine handle.</p>
</dd>
</dl>
</section>
<section id="promise-types">
<h3>Promise Types<a class="headerlink" href="#promise-types" title="Link to this heading">#</a></h3>
<dl class="glossary">
<dt id="term-coroutine-promise">coroutine promise<a class="headerlink" href="#term-coroutine-promise" title="Link to this term">#</a></dt><dd><p>The coroutine <em>promise</em> implements the primary control surface for a C++
coroutine.</p>
<p>When a coroutine function is called, a promise object will be created
automatically in an unspecified storage location (usually dynamically
allocated beside the coroutine state, but may be elided). The promise will
live as long as the coroutine is alive, and will be destroyed when the
coroutine is destroyed. A promise object is never moved nor copied (its
address is always stable).</p>
<p><code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code> uses two main promise types: <a class="reference internal" href="#_CPPv4N7amongoc15emitter_promiseE" title="amongoc::emitter_promise"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">emitter_promise</span></code></a> and
<code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task&lt;T&gt;::promise_type</span></code>.</p>
</dd>
</dl>
<p>A coroutine promise should implement the following interface:</p>
<dl class="cpp concept">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc17promise_interfaceE">
<span id="_CPPv3I0EN7amongoc17promise_interfaceE"></span><span id="_CPPv2I0EN7amongoc17promise_interfaceE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">P</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="k"><span class="pre">concept</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">promise_interface</span></span></span><a class="headerlink" href="#_CPPv4I0EN7amongoc17promise_interfaceE" title="Link to this definition">#</a><br /></dt>
<dd><div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is not a real library concept, and is only to describe the coroutine promise
interface.</p>
</div>
<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interface17get_return_objectEv">
<span id="_CPPv3N7amongoc17promise_interface17get_return_objectEv"></span><span id="_CPPv2N7amongoc17promise_interface17get_return_objectEv"></span><span id="amongoc::promise_interface::get_return_object"></span><span class="sig-name descname"><span class="n"><span class="pre">get_return_object</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interface17get_return_objectEv" title="Link to this definition">#</a><br /></dt>
<dd><p>This function will be called to get the object that is returned when a
coroutine function is initially called. In the following:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">my_coroutine_obj</span><span class="w"> </span><span class="nf">do_stuff</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">co_await</span><span class="w"> </span><span class="n">do_other_stuff</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">my_coroutine_obj</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_stuff</span><span class="p">();</span>
</pre></div>
</div>
<p>The promise’s <a class="reference internal" href="#_CPPv4N7amongoc17promise_interface17get_return_objectEv" title="amongoc::promise_interface::get_return_object"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">get_return_object()</span></code></a> is responsible for constructing the
<code class="docutils literal notranslate"><span class="pre">my_coroutine_obj</span></code> object returned when <code class="docutils literal notranslate"><span class="pre">do_stuff()</span></code> is first called.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interface39get_return_object_on_allocation_failureEv">
<span id="_CPPv3N7amongoc17promise_interface39get_return_object_on_allocation_failureEv"></span><span id="_CPPv2N7amongoc17promise_interface39get_return_object_on_allocation_failureEv"></span><span id="amongoc::promise_interface::get_return_object_on_allocation_failure"></span><span class="k"><span class="pre">static</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">get_return_object_on_allocation_failure</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interface39get_return_object_on_allocation_failureEv" title="Link to this definition">#</a><br /></dt>
<dd><p>This is required if the promise implements custom memory allocation in a
way that doesn’t throw.</p>
<p>This will be called instead of <a class="reference internal" href="#_CPPv4N7amongoc17promise_interface17get_return_objectEv" title="amongoc::promise_interface::get_return_object"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">get_return_object()</span></code></a> if the custom
<a class="reference internal" href="#_CPPv4N7amongoc17promise_interfacenwE11std__size_tDpRRDa" title="amongoc::promise_interface::operator new"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">operator</span> <span class="pre">new()</span></code></a> returns a null pointer.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interface19unhandled_exceptionEv">
<span id="_CPPv3N7amongoc17promise_interface19unhandled_exceptionEv"></span><span id="_CPPv2N7amongoc17promise_interface19unhandled_exceptionEv"></span><span id="amongoc::promise_interface::unhandled_exception"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">unhandled_exception</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interface19unhandled_exceptionEv" title="Link to this definition">#</a><br /></dt>
<dd><p>This function is invoked as-if within a <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">catch</span></code> block that encloses the
entire coroutine body. It allows the coroutine to handle exceptions that
escape without being handled.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interface15initial_suspendEv">
<span id="_CPPv3N7amongoc17promise_interface15initial_suspendEv"></span><span id="_CPPv2N7amongoc17promise_interface15initial_suspendEv"></span><span id="amongoc::promise_interface::initial_suspend"></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><span class="n"><span class="pre">awaiter</span></span></a><span class="w"> </span><span class="k"><span class="pre">auto</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">initial_suspend</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interface15initial_suspendEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Must return an <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaiter</span></code></a> that acts as the initial suspend point for
the coroutine. This happens before any code within the coroutine body
executes. This is usually <a class="reference external" href="https://en.cppreference.com/w/cpp/coroutine/suspend_always" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::suspend_always</span></code></a> or <a class="reference external" href="https://en.cppreference.com/w/cpp/coroutine/suspend_never" title="(in cppreference v0)"><code class="docutils literal notranslate"><span class="pre">std::suspend_never</span></code></a>.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interface13final_suspendEv">
<span id="_CPPv3N7amongoc17promise_interface13final_suspendEv"></span><span id="_CPPv2N7amongoc17promise_interface13final_suspendEv"></span><span id="amongoc::promise_interface::final_suspend"></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><span class="n"><span class="pre">awaiter</span></span></a><span class="w"> </span><span class="k"><span class="pre">auto</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">final_suspend</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interface13final_suspendEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Must return an <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaiter</span></code></a> that acts as the final suspend point for the
coroutine. This happens after all code within the coroutine body executes.
It runs after any <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_return</span></code> statement or after an unhandled exception
escapes.</p>
<p>If the coroutine does not suspend at its final suspend point, then the
coroutine will be immediately destroyed by the runtime and all outstanding
<a class="reference internal" href="#term-coroutine-handle"><span class="xref std std-term">coroutine handles</span></a> are invalidated (for this
reason, it is most common to always suspend at the final suspend point).</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interface12return_valueERRDa">
<span id="_CPPv3N7amongoc17promise_interface12return_valueERRDa"></span><span id="_CPPv2N7amongoc17promise_interface12return_valueERRDa"></span><span id="amongoc::promise_interface::return_value__autoRR"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">return_value</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">auto</span></span><span class="w"> </span><span class="p"><span class="pre">&amp;</span></span><span class="p"><span class="pre">&amp;</span></span><span class="n sig-param"><span class="pre">x</span></span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interface12return_valueERRDa" title="Link to this definition">#</a><br /></dt>
<dd><p>This function is invoked when a <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_return</span></code> statement is executed in
the coroutine body. The parameter <a class="reference internal" href="#_CPPv4N7amongoc17promise_interface12return_valueERRDa" title="amongoc::promise_interface::return_value::x"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">x</span></code></a> is the operand to the <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_return</span></code>
statement.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interface17promise_interfaceEDpRRDa">
<span id="_CPPv3N7amongoc17promise_interface17promise_interfaceEDpRRDa"></span><span id="_CPPv2N7amongoc17promise_interface17promise_interfaceEDpRRDa"></span><span id="amongoc::promise_interface::promise_interface__autoRRDp"></span><span class="sig-name descname"><span class="n"><span class="pre">promise_interface</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">auto</span></span><span class="p"><span class="pre">&amp;</span></span><span class="p"><span class="pre">&amp;</span></span><span class="p"><span class="pre">...</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">args</span></span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interface17promise_interfaceEDpRRDa" title="Link to this definition">#</a><br /></dt>
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interfacenwE11std__size_tDpRRDa">
<span id="_CPPv3N7amongoc17promise_interfacenwE11std__size_tDpRRDa"></span><span id="_CPPv2N7amongoc17promise_interfacenwE11std__size_tDpRRDa"></span><span id="amongoc::promise_interface::new-operator__std__size_t.autoRRDp"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="k"><span class="pre">operator</span></span><span class="w"> </span><span class="o"><span class="pre">new</span></span></span><span class="sig-paren">(</span><a class="reference external" href="https://en.cppreference.com/w/cpp/types/size_t" title="(in cppreference v0)"><span class="n"><span class="pre">std::size_t</span></span></a><span class="w"> </span><span class="n sig-param"><span class="pre">n</span></span>, <span class="kt"><span class="pre">auto</span></span><span class="p"><span class="pre">&amp;</span></span><span class="p"><span class="pre">&amp;</span></span><span class="p"><span class="pre">...</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">args</span></span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interfacenwE11std__size_tDpRRDa" title="Link to this definition">#</a><br /></dt>
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interfacedlEPv11std__size_t">
<span id="_CPPv3N7amongoc17promise_interfacedlEPv11std__size_t"></span><span id="_CPPv2N7amongoc17promise_interfacedlEPv11std__size_t"></span><span id="amongoc::promise_interface::delete-operator__voidP.std__size_t"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="k"><span class="pre">operator</span></span><span class="w"> </span><span class="o"><span class="pre">delete</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">p</span></span>, <a class="reference external" href="https://en.cppreference.com/w/cpp/types/size_t" title="(in cppreference v0)"><span class="n"><span class="pre">std::size_t</span></span></a><span class="w"> </span><span class="n sig-param"><span class="pre">n</span></span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interfacedlEPv11std__size_t" title="Link to this definition">#</a><br /></dt>
<dd><p>Implements dynamic memory allocation and construction for the coroutine
state and promise. <a class="reference internal" href="#_CPPv4N7amongoc17promise_interfacedlEPv11std__size_t" title="amongoc::promise_interface::operator delete::n"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">n</span></code></a> specifies the minimum number of bytes required for
the coroutine state. The arguments <a class="reference internal" href="#_CPPv4N7amongoc17promise_interfacenwE11std__size_tDpRRDa" title="amongoc::promise_interface::operator new::args"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">args</span></code></a> are the arguments that are given
when the coroutine function was invoked. This allows <a class="reference internal" href="#_CPPv4N7amongoc17promise_interfacenwE11std__size_tDpRRDa" title="amongoc::promise_interface::operator new"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">operator</span> <span class="pre">new()</span></code></a> and the
promise constructor to have access to any arguments passed to the coroutine,
allowing for allocator injection and behavior customization.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>At time of writing, GCC has a bug if the coroutine function is a
non-static member function and the promise has customized <a class="reference internal" href="#_CPPv4N7amongoc17promise_interfacenwE11std__size_tDpRRDa" title="amongoc::promise_interface::operator new"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">operator</span> <span class="pre">new()</span></code></a>.
C++ requires that the object of the member function is passed as the first
argument in <a class="reference internal" href="#_CPPv4N7amongoc17promise_interfacenwE11std__size_tDpRRDa" title="amongoc::promise_interface::operator new::args"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">args</span></code></a>, but GCC 14 itself will crash if it encounters this
situation.</p>
</div>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interface14get_stop_tokenEv">
<span id="_CPPv3N7amongoc17promise_interface14get_stop_tokenEv"></span><span id="_CPPv2N7amongoc17promise_interface14get_stop_tokenEv"></span><span id="amongoc::promise_interface::get_stop_token"></span><span class="kt"><span class="pre">auto</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">get_stop_token</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interface14get_stop_tokenEv" title="Link to this definition">#</a><br /></dt>
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc17promise_interface13get_allocatorEv">
<span id="_CPPv3N7amongoc17promise_interface13get_allocatorEv"></span><span id="_CPPv2N7amongoc17promise_interface13get_allocatorEv"></span><span id="amongoc::promise_interface::get_allocator"></span><span class="kt"><span class="pre">auto</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">get_allocator</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc17promise_interface13get_allocatorEv" title="Link to this definition">#</a><br /></dt>
<dd><div class="admonition note">
<p class="admonition-title">Note</p>
<p>These functions are not part of the standard C++ coroutine
interface, but are used by <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code> to transmit stop tokens and
allocators between coroutines and <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a>s.</p>
</div>
<p>Returns the stop token and the allocator associated with the coroutine.</p>
</dd></dl>

</dd></dl>

<dl class="cpp class">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc33coroutine_promise_allocator_mixinE">
<span id="_CPPv3N7amongoc33coroutine_promise_allocator_mixinE"></span><span id="_CPPv2N7amongoc33coroutine_promise_allocator_mixinE"></span><span id="amongoc::coroutine_promise_allocator_mixin"></span><span class="k"><span class="pre">class</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">coroutine_promise_allocator_mixin</span></span></span><a class="headerlink" href="#_CPPv4N7amongoc33coroutine_promise_allocator_mixinE" title="Link to this definition">#</a><br /></dt>
<dd><p>A mixin base class for promise types that implements dynamic memory allocation
according to <a class="reference internal" href="#co-alloc"><span class="std std-ref">Memory Allocation</span></a>.</p>
</dd></dl>

<dl class="cpp struct">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc15emitter_promiseE">
<span id="_CPPv3N7amongoc15emitter_promiseE"></span><span id="_CPPv2N7amongoc15emitter_promiseE"></span><span id="amongoc::emitter_promise"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">emitter_promise</span></span></span><span class="w"> </span><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference internal" href="#_CPPv4N7amongoc33coroutine_promise_allocator_mixinE" title="amongoc::coroutine_promise_allocator_mixin"><span class="n"><span class="pre">coroutine_promise_allocator_mixin</span></span></a><a class="headerlink" href="#_CPPv4N7amongoc15emitter_promiseE" title="Link to this definition">#</a><br /></dt>
<dd><p>Implements <a class="reference internal" href="#_CPPv4I0EN7amongoc17promise_interfaceE" title="amongoc::promise_interface"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">promise_interface</span></code></a> for coroutines with an <a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a>
declared return type. Only the notable members are documented below.</p>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc15emitter_promise11fin_handlerE">
<span id="_CPPv3N7amongoc15emitter_promise11fin_handlerE"></span><span id="_CPPv2N7amongoc15emitter_promise11fin_handlerE"></span><span id="amongoc::emitter_promise::fin_handler__unique_handler"></span><a class="reference internal" href="../../ref/handler/#_CPPv4N7amongoc14unique_handlerE" title="amongoc::unique_handler"><span class="n"><span class="pre">unique_handler</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">fin_handler</span></span></span><a class="headerlink" href="#_CPPv4N7amongoc15emitter_promise11fin_handlerE" title="Link to this definition">#</a><br /></dt>
<dd><p>This is the handler that is attached to the emitter during
<a class="reference internal" href="../../ref/emitter/#_CPPv431amongoc_emitter_connect_handler15amongoc_emitter15amongoc_handler" title="amongoc_emitter_connect_handler"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter_connect_handler()</span></code></a>. This starts out as a null handler until
the emitter is connected.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4NK7amongoc15emitter_promise14get_stop_tokenEv">
<span id="_CPPv3NK7amongoc15emitter_promise14get_stop_tokenEv"></span><span id="_CPPv2NK7amongoc15emitter_promise14get_stop_tokenEv"></span><span id="amongoc::emitter_promise::get_stop_tokenC"></span><a class="reference internal" href="../../ref/handler/#_CPPv418handler_stop_token" title="handler_stop_token"><span class="n"><span class="pre">handler_stop_token</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">get_stop_token</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="k"><span class="pre">const</span></span><a class="headerlink" href="#_CPPv4NK7amongoc15emitter_promise14get_stop_tokenEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Returns the stop token associated with <a class="reference internal" href="#_CPPv4N7amongoc15emitter_promise11fin_handlerE" title="amongoc::emitter_promise::fin_handler"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">fin_handler</span></code></a>.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc15emitter_promise39get_return_object_on_allocation_failureEv">
<span id="_CPPv3N7amongoc15emitter_promise39get_return_object_on_allocation_failureEv"></span><span id="_CPPv2N7amongoc15emitter_promise39get_return_object_on_allocation_failureEv"></span><span id="amongoc::emitter_promise::get_return_object_on_allocation_failure"></span><span class="k"><span class="pre">static</span></span><span class="w"> </span><a class="reference internal" href="../../ref/emitter/#_CPPv415amongoc_emitter" title="amongoc_emitter"><span class="n"><span class="pre">amongoc_emitter</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">get_return_object_on_allocation_failure</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="k"><span class="pre">noexcept</span></span><a class="headerlink" href="#_CPPv4N7amongoc15emitter_promise39get_return_object_on_allocation_failureEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Returns an emitter from <a class="reference internal" href="../../ref/async/#_CPPv421amongoc_alloc_failurev" title="amongoc_alloc_failure"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_alloc_failure()</span></code></a>.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc15emitter_promise19unhandled_exceptionEv">
<span id="_CPPv3N7amongoc15emitter_promise19unhandled_exceptionEv"></span><span id="_CPPv2N7amongoc15emitter_promise19unhandled_exceptionEv"></span><span id="amongoc::emitter_promise::unhandled_exception"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">unhandled_exception</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="k"><span class="pre">noexcept</span></span><a class="headerlink" href="#_CPPv4N7amongoc15emitter_promise19unhandled_exceptionEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Implements a conversion from an unhandled exception type to an
<a class="reference internal" href="../../ref/status/#_CPPv414amongoc_status" title="amongoc_status"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_status</span></code></a> value that will be sent to <a class="reference internal" href="#_CPPv4N7amongoc15emitter_promise11fin_handlerE" title="amongoc::emitter_promise::fin_handler"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">fin_handler</span></code></a>. Only a subset of
exception types are supported, and other exceptions will cause the program
to terminate.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc15emitter_promise13final_suspendEv">
<span id="_CPPv3N7amongoc15emitter_promise13final_suspendEv"></span><span id="_CPPv2N7amongoc15emitter_promise13final_suspendEv"></span><span id="amongoc::emitter_promise::final_suspend"></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><span class="n"><span class="pre">awaiter</span></span></a><span class="w"> </span><span class="k"><span class="pre">auto</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">final_suspend</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="k"><span class="pre">noexcept</span></span><a class="headerlink" href="#_CPPv4N7amongoc15emitter_promise13final_suspendEv" title="Link to this definition">#</a><br /></dt>
<dd><p>During final suspension, the handler <a class="reference internal" href="#_CPPv4N7amongoc15emitter_promise11fin_handlerE" title="amongoc::emitter_promise::fin_handler"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">fin_handler</span></code></a> will be completed with
the final result value for the coroutine.</p>
</dd></dl>

</dd></dl>

<dl class="cpp struct">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc7co_task13finisher_baseE">
<span id="_CPPv3I0EN7amongoc7co_task13finisher_baseE"></span><span id="_CPPv2I0EN7amongoc7co_task13finisher_baseE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">T</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-prename descclassname"><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><span class="n"><span class="pre">co_task</span></span></a><span class="p"><span class="pre">&lt;</span></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task::T"><span class="n"><span class="pre">T</span></span></a><span class="p"><span class="pre">&gt;</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">finisher_base</span></span></span><a class="headerlink" href="#_CPPv4I0EN7amongoc7co_task13finisher_baseE" title="Link to this definition">#</a><br /></dt>
<dd><p>Abstract base class that implements the behavior when a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> completes.
This allows for a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> to act as a <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> or as an <a class="reference internal" href="#_CPPv4I0EN7amongoc9awaitableE" title="amongoc::awaitable"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaitable</span></code></a>.</p>
<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc7co_task13finisher_base16on_final_suspendEv">
<span id="_CPPv3N7amongoc7co_task13finisher_base16on_final_suspendEv"></span><span id="_CPPv2N7amongoc7co_task13finisher_base16on_final_suspendEv"></span><span id="amongoc::co_task::finisher_base::on_final_suspend"></span><span class="k"><span class="pre">virtual</span></span><span class="w"> </span><span class="n"><span class="pre">std</span></span><span class="p"><span class="pre">::</span></span><span class="n"><span class="pre">coroutine_handle</span></span><span class="p"><span class="pre">&lt;</span></span><span class="p"><span class="pre">&gt;</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">on_final_suspend</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="m"><span class="pre">0</span></span><a class="headerlink" href="#_CPPv4N7amongoc7co_task13finisher_base16on_final_suspendEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Called after final suspension of the coroutine. The returned coroutine will
be resumed after the <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> completes.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc7co_task13finisher_base10stop_tokenEv">
<span id="_CPPv3N7amongoc7co_task13finisher_base10stop_tokenEv"></span><span id="_CPPv2N7amongoc7co_task13finisher_base10stop_tokenEv"></span><span id="amongoc::co_task::finisher_base::stop_token"></span><span class="k"><span class="pre">virtual</span></span><span class="w"> </span><span class="n"><span class="pre">in_place_stop_token</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">stop_token</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="m"><span class="pre">0</span></span><a class="headerlink" href="#_CPPv4N7amongoc7co_task13finisher_base10stop_tokenEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Obtian the stop token for use with the coroutine.</p>
</dd></dl>

</dd></dl>

<dl class="cpp struct">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc7co_task12promise_typeE">
<span id="_CPPv3I0EN7amongoc7co_task12promise_typeE"></span><span id="_CPPv2I0EN7amongoc7co_task12promise_typeE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">T</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-prename descclassname"><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><span class="n"><span class="pre">co_task</span></span></a><span class="p"><span class="pre">&lt;</span></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task::T"><span class="n"><span class="pre">T</span></span></a><span class="p"><span class="pre">&gt;</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">promise_type</span></span></span><span class="w"> </span><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference internal" href="#_CPPv4N7amongoc33coroutine_promise_allocator_mixinE" title="amongoc::coroutine_promise_allocator_mixin"><span class="n"><span class="pre">coroutine_promise_allocator_mixin</span></span></a><a class="headerlink" href="#_CPPv4I0EN7amongoc7co_task12promise_typeE" title="Link to this definition">#</a><br /></dt>
<dd><p>Implements the <a class="reference internal" href="#_CPPv4I0EN7amongoc17promise_interfaceE" title="amongoc::promise_interface"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">promise_interface</span></code></a> for <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> coroutines.</p>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc7co_task12promise_type9_finisherE">
<span id="_CPPv3N7amongoc7co_task12promise_type9_finisherE"></span><span id="_CPPv2N7amongoc7co_task12promise_type9_finisherE"></span><span id="amongoc::co_task::promise_type::_finisher__finisher_baseP"></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_task13finisher_baseE" title="amongoc::co_task::finisher_base"><span class="n"><span class="pre">finisher_base</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">_finisher</span></span></span><a class="headerlink" href="#_CPPv4N7amongoc7co_task12promise_type9_finisherE" title="Link to this definition">#</a><br /></dt>
<dd><p>A pointer to a concrete <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_task13finisher_baseE" title="amongoc::co_task::finisher_base"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">finisher_base</span></code></a> object that tells the coroutine how
to execute.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc7co_task12promise_type14get_stop_tokenEv">
<span id="_CPPv3N7amongoc7co_task12promise_type14get_stop_tokenEv"></span><span id="_CPPv2N7amongoc7co_task12promise_type14get_stop_tokenEv"></span><span id="amongoc::co_task::promise_type::get_stop_token"></span><span class="n"><span class="pre">in_place_stop_token</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">get_stop_token</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc7co_task12promise_type14get_stop_tokenEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Obtains a stop token via <a class="reference internal" href="#_CPPv4N7amongoc7co_task12promise_type9_finisherE" title="amongoc::co_task::promise_type::_finisher"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">_finisher</span></code></a> <a class="reference internal" href="#_CPPv4N7amongoc7co_task13finisher_base10stop_tokenEv" title="amongoc::co_task::finisher_base::stop_token"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">finisher_base::stop_token()</span></code></a></p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc7co_task12promise_type13final_suspendEv">
<span id="_CPPv3N7amongoc7co_task12promise_type13final_suspendEv"></span><span id="_CPPv2N7amongoc7co_task12promise_type13final_suspendEv"></span><span id="amongoc::co_task::promise_type::final_suspend"></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_task7awaiterE" title="amongoc::co_task::awaiter"><span class="n"><span class="pre">awaiter</span></span></a><span class="w"> </span><span class="k"><span class="pre">auto</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">final_suspend</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc7co_task12promise_type13final_suspendEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Implements the final suspend point. Final suspension simply returns the
coroutine handle of <a class="reference internal" href="#_CPPv4N7amongoc7co_task13finisher_base16on_final_suspendEv" title="amongoc::co_task::finisher_base::on_final_suspend"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">finisher_base::on_final_suspend()</span></code></a> from <a class="reference internal" href="#_CPPv4N7amongoc7co_task12promise_type9_finisherE" title="amongoc::co_task::promise_type::_finisher"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">_finisher</span></code></a>. The
behavior of <a class="reference internal" href="#_CPPv4N7amongoc7co_task12promise_type9_finisherE" title="amongoc::co_task::promise_type::_finisher"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">_finisher</span></code></a> depends on whether the task is used as a
<a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> or as an <a class="reference internal" href="#_CPPv4I0EN7amongoc9awaitableE" title="amongoc::awaitable"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaitable</span></code></a>:</p>
<ol class="arabic simple">
<li><p>As a <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a>, the finisher will invoke the receiver attached to the
nanosender, passing it the <a class="reference internal" href="#_CPPv4N7amongoc7co_task11result_typeE" title="amongoc::co_task::result_type"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">result_type</span></code></a> object for the coroutine.</p></li>
<li><p>As an <a class="reference internal" href="#_CPPv4I0EN7amongoc9awaitableE" title="amongoc::awaitable"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaitable</span></code></a>, the finisher will resume the coroutine that is
awaiting the <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a>, at which point the <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code> will either
throw an exception or return the successful return value from the
<a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a>.</p></li>
</ol>
</dd></dl>

</dd></dl>

</section>
<section id="awaiting-a-nanosender">
<h3>Awaiting a Nanosender<a class="headerlink" href="#awaiting-a-nanosender" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> await is performed by a non-member <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">operator</span><span class="w"> </span><span class="k">co_await</span><span class="p">()</span></code> that
is constrained on the <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> concept. It returns a <a class="reference internal" href="#_CPPv4I_10nanosenderEN7amongoc18nanosender_awaiterE" title="amongoc::nanosender_awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender_awaiter</span></code></a>.</p>
<dl class="cpp class">
<dt class="sig sig-object cpp" id="_CPPv4I_10nanosenderEN7amongoc18nanosender_awaiterE">
<span id="_CPPv3I_10nanosenderEN7amongoc18nanosender_awaiterE"></span><span id="_CPPv2I_10nanosenderEN7amongoc18nanosender_awaiterE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><span class="n"><span class="pre">nanosender</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">S</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="k"><span class="pre">class</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">nanosender_awaiter</span></span></span><a class="headerlink" href="#_CPPv4I_10nanosenderEN7amongoc18nanosender_awaiterE" title="Link to this definition">#</a><br /></dt>
<dd><p>Implements an <a class="reference internal" href="#_CPPv4I0EN7amongoc7awaiterE" title="amongoc::awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaiter</span></code></a> object for a <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> <span class="math notranslate nohighlight">\(S\)</span>.</p>
<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4NK7amongoc18nanosender_awaiter11await_readyEv">
<span id="_CPPv3NK7amongoc18nanosender_awaiter11await_readyEv"></span><span id="_CPPv2NK7amongoc18nanosender_awaiter11await_readyEv"></span><span id="amongoc::nanosender_awaiter::await_readyC"></span><span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">await_ready</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="k"><span class="pre">const</span></span><a class="headerlink" href="#_CPPv4NK7amongoc18nanosender_awaiter11await_readyEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if-and-only-if the underlying nanosender is known to
complete synchronously.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc18nanosender_awaiter12await_resumeEv">
<span id="_CPPv3N7amongoc18nanosender_awaiter12await_resumeEv"></span><span id="_CPPv2N7amongoc18nanosender_awaiter12await_resumeEv"></span><span id="amongoc::nanosender_awaiter::await_resume"></span><a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc7sends_tE" title="amongoc::sends_t"><span class="n"><span class="pre">sends_t</span></span></a><span class="p"><span class="pre">&lt;</span></span><a class="reference internal" href="#_CPPv4I_10nanosenderEN7amongoc18nanosender_awaiterE" title="amongoc::nanosender_awaiter::S"><span class="n"><span class="pre">S</span></span></a><span class="p"><span class="pre">&gt;</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">await_resume</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="k"><span class="pre">noexcept</span></span><a class="headerlink" href="#_CPPv4N7amongoc18nanosender_awaiter12await_resumeEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Returns the result value that was sent by the enclosed nanosender <a class="reference internal" href="#_CPPv4I_10nanosenderEN7amongoc18nanosender_awaiterE" title="amongoc::nanosender_awaiter::S"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">S</span></code></a>. This
causes <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">co_await</span></code> on a <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc10nanosenderE" title="amongoc::nanosender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender</span></code></a> to return <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc7sends_tE" title="amongoc::sends_t"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">sends_t</span></code></a> of the
nanosender type.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc18nanosender_awaiter13await_suspendEvNSt16coroutine_handleI7PromiseEE">
<span id="_CPPv3I0EN7amongoc18nanosender_awaiter13await_suspendENSt16coroutine_handleI7PromiseEE"></span><span id="_CPPv2I0EN7amongoc18nanosender_awaiter13await_suspendENSt16coroutine_handleI7PromiseEE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">Promise</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">await_suspend</span></span></span><span class="sig-paren">(</span>

<dl>
<dd><span class="n"><span class="pre">std</span></span><span class="p"><span class="pre">::</span></span><span class="n"><span class="pre">coroutine_handle</span></span><span class="p"><span class="pre">&lt;</span></span><a class="reference internal" href="#_CPPv4I0EN7amongoc18nanosender_awaiter13await_suspendEvNSt16coroutine_handleI7PromiseEE" title="amongoc::nanosender_awaiter::await_suspend::Promise"><span class="n"><span class="pre">Promise</span></span></a><span class="p"><span class="pre">&gt;</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">suspender</span></span>,</dd>
</dl>

<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4I0EN7amongoc18nanosender_awaiter13await_suspendEvNSt16coroutine_handleI7PromiseEE" title="Link to this definition">#</a><br /></dt>
<dd><p>Handles suspension. An internal <a class="reference internal" href="../nanosenders/#_CPPv4I00EN7amongoc15nanoreceiver_ofE" title="amongoc::nanoreceiver_of"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanoreceiver_of&lt;sends_t&lt;S&gt;&gt;</span></code></a> <span class="math notranslate nohighlight">\(R\)</span> is
created, which, when invoked, will call <code class="docutils literal notranslate"><span class="pre">resume()</span></code> on the <a class="reference internal" href="#_CPPv4I0EN7amongoc18nanosender_awaiter13await_suspendEvNSt16coroutine_handleI7PromiseEE" title="amongoc::nanosender_awaiter::await_suspend::suspender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">suspender</span></code></a>
coroutine. The wrapped nanosender <span class="math notranslate nohighlight">\(S\)</span> is <a class="reference internal" href="../nanosenders/#_CPPv4I_10nanosender_16nanoreceiver_forI1SEEN7amongoc7connectE13nanooperationRR1SRR1R" title="amongoc::connect"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">connected</span></code></a> to
the receiver <span class="math notranslate nohighlight">\(R\)</span> and the resulting <a class="reference internal" href="../nanosenders/#_CPPv4I0EN7amongoc13nanooperationE" title="amongoc::nanooperation"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanooperation</span></code></a> is launched immediately.
The operation state is stored within the awaiter.</p>
<p><a class="reference internal" href="../queries/"><span class="doc">Queries</span></a> on the receiver <span class="math notranslate nohighlight">\(R\)</span> are forwarded to the promise of
<a class="reference internal" href="#_CPPv4I0EN7amongoc18nanosender_awaiter13await_suspendEvNSt16coroutine_handleI7PromiseEE" title="amongoc::nanosender_awaiter::await_suspend::suspender"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">suspender</span></code></a>. This exposes the stop token and allocator of the enclosing
coroutine through the receiver <span class="math notranslate nohighlight">\(R\)</span>, and is required for cancellation to
work.</p>
</dd></dl>

</dd></dl>

</section>
<section id="awaiting-a-co-task">
<h3>Awaiting a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a><a class="headerlink" href="#awaiting-a-co-task" title="Link to this heading">#</a></h3>
<p>Awaiting on a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> calls a member function <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="k">operator</span><span class="w"> </span><span class="k">co_await</span></code> on the
<a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a>. This returns a <code class="docutils literal notranslate"><span class="pre">co_task&lt;T&gt;::awaiter</span></code> object.</p>
<dl class="cpp class">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc7co_task7awaiterE">
<span id="_CPPv3I0EN7amongoc7co_task7awaiterE"></span><span id="_CPPv2I0EN7amongoc7co_task7awaiterE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">T</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="k"><span class="pre">class</span></span><span class="w"> </span><span class="sig-prename descclassname"><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><span class="n"><span class="pre">co_task</span></span></a><span class="p"><span class="pre">&lt;</span></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task::T"><span class="n"><span class="pre">T</span></span></a><span class="p"><span class="pre">&gt;</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">awaiter</span></span></span><a class="headerlink" href="#_CPPv4I0EN7amongoc7co_task7awaiterE" title="Link to this definition">#</a><br /></dt>
<dd><p>Implements an <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_task7awaiterE" title="amongoc::co_task::awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">awaiter</span></code></a> object for a <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a></p>
<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4NK7amongoc7co_task7awaiter11await_readyEv">
<span id="_CPPv3NK7amongoc7co_task7awaiter11await_readyEv"></span><span id="_CPPv2NK7amongoc7co_task7awaiter11await_readyEv"></span><span id="amongoc::co_task::awaiter::await_readyC"></span><span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">await_ready</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="w"> </span><span class="k"><span class="pre">const</span></span><a class="headerlink" href="#_CPPv4NK7amongoc7co_task7awaiter11await_readyEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Always returns <code class="code highlight cpp c++ docutils literal highlight-c++"><span class="nb">false</span></code> (<a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a> coroutines are lazy and never
complete immediately).</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N7amongoc7co_task7awaiter12await_resumeEv">
<span id="_CPPv3N7amongoc7co_task7awaiter12await_resumeEv"></span><span id="_CPPv2N7amongoc7co_task7awaiter12await_resumeEv"></span><span id="amongoc::co_task::awaiter::await_resume"></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task::T"><span class="n"><span class="pre">T</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">await_resume</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N7amongoc7co_task7awaiter12await_resumeEv" title="Link to this definition">#</a><br /></dt>
<dd><p>Obtain the result of the awaited coroutine. If the awaited coroutine threw
an exception, this function will re-throw that same exception.</p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4I0EN7amongoc7co_task7awaiter13await_suspendENSt16coroutine_handleIEENSt16coroutine_handleI1PEE">
<span id="_CPPv3I0EN7amongoc7co_task7awaiter13await_suspendENSt16coroutine_handleI1PEE"></span><span id="_CPPv2I0EN7amongoc7co_task7awaiter13await_suspendENSt16coroutine_handleI1PEE"></span><span class="k"><span class="pre">template</span></span><span class="p"><span class="pre">&lt;</span></span><span class="k"><span class="pre">typename</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">P</span></span></span><span class="p"><span class="pre">&gt;</span></span><br /><span class="n"><span class="pre">std</span></span><span class="p"><span class="pre">::</span></span><span class="n"><span class="pre">coroutine_handle</span></span><span class="p"><span class="pre">&lt;</span></span><span class="p"><span class="pre">&gt;</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">await_suspend</span></span></span><span class="sig-paren">(</span>

<dl>
<dd><span class="n"><span class="pre">std</span></span><span class="p"><span class="pre">::</span></span><span class="n"><span class="pre">coroutine_handle</span></span><span class="p"><span class="pre">&lt;</span></span><a class="reference internal" href="#_CPPv4I0EN7amongoc7co_task7awaiter13await_suspendENSt16coroutine_handleIEENSt16coroutine_handleI1PEE" title="amongoc::co_task::awaiter::await_suspend::P"><span class="n"><span class="pre">P</span></span></a><span class="p"><span class="pre">&gt;</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">suspender</span></span>,</dd>
</dl>

<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4I0EN7amongoc7co_task7awaiter13await_suspendENSt16coroutine_handleIEENSt16coroutine_handleI1PEE" title="Link to this definition">#</a><br /></dt>
<dd><p>Suspends the parent coroutine and immediately launches the awaited coroutine.</p>
<p>As with <a class="reference internal" href="#_CPPv4I_10nanosenderEN7amongoc18nanosender_awaiterE" title="amongoc::nanosender_awaiter"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">nanosender_awaiter</span></code></a>, the stop token from <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_task7awaiter13await_suspendENSt16coroutine_handleIEENSt16coroutine_handleI1PEE" title="amongoc::co_task::awaiter::await_suspend::P"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">P</span></code></a> will be passed through
to the enclosing <a class="reference internal" href="#_CPPv4I0EN7amongoc7co_taskE" title="amongoc::co_task"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a></p>
</dd></dl>

</dd></dl>

</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../nanosenders/"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Nanosenders</p>
      </div>
    </a>
    <a class="right-next"
       href="../result/"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><code class="docutils literal notranslate"><span class="pre">result&lt;T&gt;</span></code></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coroutine-types">Coroutine Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#amongoc-emitter-as-a-coroutine"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code> as a Coroutine</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-explicit-ramp-end">The Explicit Ramp End</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exception-handling-with-amongoc-emitter">Exception Handling with <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc_emitter</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#amongoc-co-task-as-a-coroutine"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">amongoc::co_task</span></code> as a Coroutine</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_taskE"><code class="docutils literal notranslate"><span class="pre">co_task</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task11result_typeE"><code class="docutils literal notranslate"><span class="pre">result_type</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4NO7amongoc7co_task9as_senderEv"><code class="docutils literal notranslate"><span class="pre">as_sender()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exception-handling-with-co-task">Exception Handling with <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#awaitable-types">Awaitable Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exception-throwing">Exception Throwing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#memory-allocation">Memory Allocation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#allocation-failure">Allocation Failure</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-lifetimes">Parameter Lifetimes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coroutines-versus-nanosenders">Coroutines Versus Nanosenders</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-coroutines">When to Use Coroutines</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-nanosenders">When to Use Nanosenders</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coroutine-machinery-in-amongoc">Coroutine Machinery in <code class="project-name docutils literal notranslate"><span class="pre">amongoc</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#triggering-coroutine-magic">Triggering Coroutine Magic</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#support-concepts">Support Concepts</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7awaiterE"><code class="docutils literal notranslate"><span class="pre">awaiter</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7awaiter13await_suspendEDaNSt16coroutine_handleI1PEE"><code class="docutils literal notranslate"><span class="pre">await_suspend()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7awaiter12await_resumeEv"><code class="docutils literal notranslate"><span class="pre">await_resume()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7awaiter11await_readyEv"><code class="docutils literal notranslate"><span class="pre">await_ready()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc9awaitableE"><code class="docutils literal notranslate"><span class="pre">awaitable</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#promise-types">Promise Types</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc17promise_interfaceE"><code class="docutils literal notranslate"><span class="pre">promise_interface</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface17get_return_objectEv"><code class="docutils literal notranslate"><span class="pre">get_return_object()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface39get_return_object_on_allocation_failureEv"><code class="docutils literal notranslate"><span class="pre">get_return_object_on_allocation_failure()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface19unhandled_exceptionEv"><code class="docutils literal notranslate"><span class="pre">unhandled_exception()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface15initial_suspendEv"><code class="docutils literal notranslate"><span class="pre">initial_suspend()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface13final_suspendEv"><code class="docutils literal notranslate"><span class="pre">final_suspend()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface12return_valueERRDa"><code class="docutils literal notranslate"><span class="pre">return_value()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface17promise_interfaceEDpRRDa"><code class="docutils literal notranslate"><span class="pre">promise_interface()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interfacenwE11std__size_tDpRRDa"><code class="docutils literal notranslate"><span class="pre">operator</span> <span class="pre">new()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interfacedlEPv11std__size_t"><code class="docutils literal notranslate"><span class="pre">operator</span> <span class="pre">delete()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface14get_stop_tokenEv"><code class="docutils literal notranslate"><span class="pre">get_stop_token()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc17promise_interface13get_allocatorEv"><code class="docutils literal notranslate"><span class="pre">get_allocator()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc33coroutine_promise_allocator_mixinE"><code class="docutils literal notranslate"><span class="pre">coroutine_promise_allocator_mixin</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promiseE"><code class="docutils literal notranslate"><span class="pre">emitter_promise</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promise11fin_handlerE"><code class="docutils literal notranslate"><span class="pre">fin_handler</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4NK7amongoc15emitter_promise14get_stop_tokenEv"><code class="docutils literal notranslate"><span class="pre">get_stop_token()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promise39get_return_object_on_allocation_failureEv"><code class="docutils literal notranslate"><span class="pre">get_return_object_on_allocation_failure()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promise19unhandled_exceptionEv"><code class="docutils literal notranslate"><span class="pre">unhandled_exception()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc15emitter_promise13final_suspendEv"><code class="docutils literal notranslate"><span class="pre">final_suspend()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_task13finisher_baseE"><code class="docutils literal notranslate"><span class="pre">finisher_base</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task13finisher_base16on_final_suspendEv"><code class="docutils literal notranslate"><span class="pre">on_final_suspend()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task13finisher_base10stop_tokenEv"><code class="docutils literal notranslate"><span class="pre">stop_token()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_task12promise_typeE"><code class="docutils literal notranslate"><span class="pre">promise_type</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task12promise_type9_finisherE"><code class="docutils literal notranslate"><span class="pre">_finisher</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task12promise_type14get_stop_tokenEv"><code class="docutils literal notranslate"><span class="pre">get_stop_token()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task12promise_type13final_suspendEv"><code class="docutils literal notranslate"><span class="pre">final_suspend()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#awaiting-a-nanosender">Awaiting a Nanosender</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I_10nanosenderEN7amongoc18nanosender_awaiterE"><code class="docutils literal notranslate"><span class="pre">nanosender_awaiter</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4NK7amongoc18nanosender_awaiter11await_readyEv"><code class="docutils literal notranslate"><span class="pre">await_ready()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc18nanosender_awaiter12await_resumeEv"><code class="docutils literal notranslate"><span class="pre">await_resume()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc18nanosender_awaiter13await_suspendEvNSt16coroutine_handleI7PromiseEE"><code class="docutils literal notranslate"><span class="pre">await_suspend()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#awaiting-a-co-task">Awaiting a <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">co_task</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_task7awaiterE"><code class="docutils literal notranslate"><span class="pre">awaiter</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4NK7amongoc7co_task7awaiter11await_readyEv"><code class="docutils literal notranslate"><span class="pre">await_ready()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4N7amongoc7co_task7awaiter12await_resumeEv"><code class="docutils literal notranslate"><span class="pre">await_resume()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#_CPPv4I0EN7amongoc7co_task7awaiter13await_suspendENSt16coroutine_handleIEENSt16coroutine_handleI1PEE"><code class="docutils literal notranslate"><span class="pre">await_suspend()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By MongoDB
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, MongoDB.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>